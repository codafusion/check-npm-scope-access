name: Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag (for example v1.2.3)"
                required: true
                type: string

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Resolve release tag
                id: resolve_tag
                shell: bash
                run: |
                    set -euo pipefail
                    if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
                      tag="${GITHUB_REF_NAME}"
                    else
                      tag="${{ inputs.tag }}"
                    fi

                    if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                      echo "Invalid tag: $tag (expected vX.Y.Z)"
                      exit 1
                    fi

                    echo "tag=$tag" >> "$GITHUB_OUTPUT"

            -   name: Create GitHub release
                shell: bash
                env:
                    GH_TOKEN: ${{ github.token }}
                run: |
                    set -euo pipefail
                    tag="${{ steps.resolve_tag.outputs.tag }}"

                    if gh release view "$tag" >/dev/null 2>&1; then
                      echo "Release for $tag already exists. Skipping creation."
                      exit 0
                    fi

                    gh release create "$tag" \
                      --verify-tag \
                      --generate-notes \
                      --latest

            -   name: Move major tag
                shell: bash
                run: |
                    set -euo pipefail
                    tag="${{ steps.resolve_tag.outputs.tag }}"
                    major_tag="$(echo "$tag" | sed -E 's/^v([0-9]+)\..*/v\1/')"

                    git config user.name "github-actions[bot]"
                    git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                    git tag -f "$major_tag" "$tag"
                    git push origin "refs/tags/$major_tag" --force
